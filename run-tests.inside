#!/bin/bash
set -ex

# Start udev before running sgdisk, because it doesn't
# run any rules for preexisting devices (not expected behavior)
#UDEV_LOG=info \
udevd & sleep .1
#udevadm trigger --action=add --subsystem-match=block
#udevadm trigger --action=change --subsystem-match=block
#udevadm settle
#ls -Artlh /dev/block

coverage-3.3 erase
# shopt -s expand_aliases also works
function blocks {
    coverage-3.3 run --append --source=blocks -m blocks "$@"
}

! blocks

sgdisk --new=1:1M:+127M --new=2:129M:+127M \
    --new=3:256M:+128M --new=4:384M:+128M -p /dev/ubda
udevadm settle
#ls -Artlh /dev/block

# Somehow udev breaks lvm in the next test
udevadm control --exit

mkfs.ext4 /dev/ubda1
blocks to-lvm /dev/ubda1
! blocks to-lvm /dev/ubda1

# Relies on /dev/block/ device names when doing ptable lookup
# 2713e6ab0abfc47a54ccbae26be22471aef46b24, udev 165, udev_node_add
blocks to-bcache /dev/ubda2
! blocks to-bcache /dev/ubda2

# Can't shrink an unrecognised partition
! blocks to-bcache /dev/ubda4
#mkfs.btrfs /dev/ubda3
# Fails, but _BHRfS_M does appear in the strace, what drugs is blkid on?
#strace -s1024 -f blkid -p -c /dev/null /dev/ubda3
# ReiserFS has too much interactivity
#mkfs.reiserfs /dev/ubda3
mkfs.nilfs2 -B 1024 /dev/ubda3
blkid /dev/ubda3

blocks to-bcache /dev/ubda4
! blocks to-bcache /dev/ubda4

vgchange -ay
#ls -Artlh /dev/mapper

vgcfgbackup --file before ubda1
blocks --debug to-bcache /dev/mapper/ubda1-ubda1
vgcfgbackup --file after ubda1
! blocks to-bcache /dev/mapper/ubda1-ubda1
blocks --debug rotate /dev/mapper/ubda1-ubda1
vgcfgbackup --file before.restored ubda1
! blocks rotate /dev/mapper/ubda1-ubda1
blocks --debug to-bcache /dev/mapper/ubda1-ubda1
vgcfgbackup --file after.twice ubda1

# Those must be identical except for seqno and various timestamps
git --no-pager diff --no-index --patience before before.restored ||:
git --no-pager diff --no-index --patience after after.twice ||:

coverage-3.3 report -m
coverage-3.3 annotate

